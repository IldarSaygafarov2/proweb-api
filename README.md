# DRF Интернет-магазин — 3 версии API

## Описание
В проекте реализовано 3 версии API для интернет-магазина на Django REST Framework:
- **api_v1** — с критическими (Blocker) и другими ошибками
- **api_v2** — без ошибок класса Blocker, но с Critical/Major
- **api_v3** — полностью рабочий API без ошибок

---

## Быстрый старт
1. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```
2. Примените миграции:
   ```bash
   python manage.py migrate
   ```
3. Заполните базу тестовыми товарами и категориями:
   ```bash
   python populate_demo_data.py
   ```
4. Запустите сервер:
   ```bash
   python manage.py runserver
   ```

---

## Модели и структура данных

### Category
| Поле        | Тип         | Описание                       |
|-------------|-------------|--------------------------------|
| id          | int         | ID категории                   |
| name        | str         | Название                       |
| description | str         | Описание                       |

### Product
| Поле      | Тип     | Описание                        |
|-----------|---------|---------------------------------|
| id        | int     | ID товара                       |
| name      | str     | Название                        |
| price     | str     | Цена (Decimal, строкой)         |
| stock     | int     | Количество на складе            |
| image_url | str     | Ссылка на изображение           |
| diaganal  | str     | Диагональ (опечатка!)           |
| category  | object  | Объект категории                |

**Пример Product:**
```json
{
  "id": 1,
  "name": "iPhone 14",
  "price": "79990.00",
  "stock": 10,
  "image_url": "https://example.com/iphone14.jpg",
  "diaganal": "6.1",
  "category": {
    "id": 1,
    "name": "Смартфоны",
    "description": "Мобильные телефоны и смартфоны"
  }
}
```

### PromoCode
| Поле           | Тип   | Описание         |
|----------------|-------|------------------|
| id             | int   | ID промокода     |
| code           | str   | Код              |
| discount_percent | int | Процент скидки   |
| is_active      | bool  | Активен          |

### Order
| Поле       | Тип   | Описание                |
|------------|-------|-------------------------|
| id         | int   | ID заказа               |
| user       | int   | ID пользователя         |
| created_at | str   | Дата создания           |
| total      | str   | Итоговая сумма          |
| promo_code | int   | ID промокода (или null) |

### Cart
| Поле    | Тип    | Описание                 |
|---------|--------|--------------------------|
| id      | int    | ID корзины               |
| user    | int    | ID пользователя          |
| products| array  | Список CartItem          |

### CartItem
| Поле     | Тип    | Описание         |
|----------|--------|------------------|
| id       | int    | ID CartItem      |
| product  | object | Объект Product   |
| quantity | int    | Количество       |

---

## Наполнение базы (populate_demo_data.py)

Скрипт автоматически создаёт 5 категорий и по 5 товаров в каждой. Пример категорий:
- Смартфоны
- Ноутбуки
- Телевизоры
- Планшеты
- Аксессуары

Пример товара:
```json
{
  "name": "iPhone 14",
  "price": 79990,
  "stock": 10,
  "image_url": "https://example.com/iphone14.jpg",
  "diaganal": "6.1"
}
```

---

## Аутентификация и регистрация (Djoser)
В каждой версии API доступны современные эндпоинты для регистрации, логина, работы с токенами и JWT (через [Djoser](https://djoser.readthedocs.io/en/latest/)):

| Эндпоинт                        | Описание                       |
|---------------------------------|--------------------------------|
| `/auth/users/`                  | Регистрация пользователя (POST) |
| `/auth/token/login/`            | Получение токена (POST)         |
| `/auth/token/logout/`           | Выход (аннулирование токена)    |
| `/auth/jwt/create/`             | Получение JWT (POST)            |
| `/auth/jwt/refresh/`            | Обновление JWT (POST)           |
| `/auth/jwt/verify/`             | Проверка JWT (POST)             |
| `/auth/users/me/`               | Информация о текущем пользователе (GET) |
| `/auth/users/reset_password/`   | Сброс пароля (POST)             |

**Пример регистрации:**
```http
POST /api_v3/auth/users/
{
  "username": "testuser",
  "password": "testpass123",
  "re_password": "testpass123"
}
```

**Пример получения токена:**
```http
POST /api_v3/auth/token/login/
{
  "username": "testuser",
  "password": "testpass123"
}
```
Ответ: `{ "auth_token": "..." }`

**Пример получения JWT:**
```http
POST /api_v3/auth/jwt/create/
{
  "username": "testuser",
  "password": "testpass123"
}
```
Ответ: `{ "access": "...", "refresh": "..." }`

**Пример запроса с токеном:**
```http
GET /api_v3/products/
Authorization: Token <auth_token>
```
или
```http
Authorization: Bearer <access>
```

---

## Требования к авторизации для эндпоинтов

| Эндпоинт                | v1 (api_v1) | v2 (api_v2) | v3 (api_v3) |
|-------------------------|:-----------:|:-----------:|:-----------:|
| `/products/`            | ❌ (публично, ошибка) | ✅ (только с токеном) | ✅ (только с токеном) |
| `/products/<id>/`       | ❌ (публично, ошибка) | ✅ (только с токеном) | ✅ (только с токеном) |
| `/cart/add/`            | ❌           | ✅           | ✅           |
| `/cart/apply-promocode/`| ❌           | ✅           | ✅           |
| `/pay/`                 | ❌           | ✅           | ✅           |
| `/orders/history/`      | ❌           | ✅           | ✅           |
| `/auth/...`             | ✅           | ✅           | ✅           |

- ✅ — требуется авторизация (Token/JWT)
- ❌ — доступно публично (в v1 это ошибка по заданию)

---

## Структура API и ошибки

### 1. API v1 (`/api_v1/`)
**Содержит ошибки класса Blocker, Critical, Major**

| Эндпоинт                | Описание | Ошибки | Требует авторизации |
|-------------------------|----------|--------|--------------------|
| `/`                     | Главная страница | **Всегда 503 Service Unavailable** (Blocker) | ❌ |
| `/products/`            | Каталог товаров | **Бесконечная загрузка** (Blocker) | ❌ (ошибка) |
| `/products/<id>/`       | Детали товара | **Неверное изображение** (Major) | ❌ (ошибка) |
| `/login/`               | Логин | **Сессия/токен не сохраняется** (Blocker) | ❌ |
| `/cart/add/`            | Добавить в корзину | **Можно добавить товар, которого нет в наличии** (Critical) | ❌ |
| `/cart/apply-promocode/`| Применить промокод | **Скидка не применяется к сумме** (Critical) | ❌ |
| `/pay/`                 | Оплата | **Оплата всегда ошибка** (Critical) | ❌ |
| `/orders/history/`      | История заказов | **Всегда пусто** (Major) | ❌ |
| `/password-reset/`      | Сброс пароля | **Письмо не отправляется** (Major) | ❌ |
| `/auth/...`             | Djoser-эндпоинты | Работают корректно | ✅ |

#### Подробнее об ошибках:
- **Blocker**: полностью блокируют работу (503, бесконечная загрузка, нет сессии после логина)
- **Critical**: ключевые функции не работают (оплата, промокод, добавление товара без проверки)
- **Major**: важные, но не критичные баги (история заказов, неверное изображение)

---

### 2. API v2 (`/api_v2/`)
**Ошибки Blocker устранены, но Critical/Major остались**

| Эндпоинт                | Описание | Ошибки | Требует авторизации |
|-------------------------|----------|--------|--------------------|
| `/`                     | Главная страница | Работает | ❌ |
| `/products/`            | Каталог товаров | Работает | ✅ |
| `/products/<id>/`       | Детали товара | **Неверное изображение** (Major) | ✅ |
| `/login/`               | Логин | Работает (сессия сохраняется) | ❌ |
| `/cart/add/`            | Добавить в корзину | **Можно добавить товар, которого нет в наличии** (Critical) | ✅ |
| `/cart/apply-promocode/`| Применить промокод | **Скидка не применяется к сумме** (Critical) | ✅ |
| `/pay/`                 | Оплата | **Оплата всегда ошибка** (Critical) | ✅ |
| `/orders/history/`      | История заказов | **Всегда пусто** (Major) | ✅ |
| `/password-reset/`      | Сброс пароля | **Письмо не отправляется** (Major) | ❌ |
| `/auth/...`             | Djoser-эндпоинты | Работают корректно | ✅ |

---

### 3. API v3 (`/api_v3/`)
**Ошибок нет, все функции работают корректно**

| Эндпоинт                | Описание | Ошибки | Требует авторизации |
|-------------------------|----------|--------|--------------------|
| `/`                     | Главная страница | Работает | ❌ |
| `/products/`            | Каталог товаров | Работает, поддерживает сортировку (`?sort=price_asc`/`price_desc`) и пагинацию | ✅ |
| `/products/<id>/`       | Детали товара | Работает, правильное изображение | ✅ |
| `/login/`               | Логин | Работает, сессия сохраняется | ❌ |
| `/cart/add/`            | Добавить в корзину | Проверяется наличие товара на складе | ✅ |
| `/cart/apply-promocode/`| Применить промокод | Скидка реально применяется к сумме | ✅ |
| `/pay/`                 | Оплата | Проходит успешно, корзина очищается, создается заказ | ✅ |
| `/orders/history/`      | История заказов | Возвращает реальные заказы пользователя | ✅ |
| `/password-reset/`      | Сброс пароля | Имитация отправки письма | ❌ |
| `/auth/...`             | Djoser-эндпоинты | Работают корректно | ✅ |

---

## Примеры запросов и ответов

### Получить каталог товаров (v2/v3 — только с токеном)
```http
GET /api_v2/products/
Authorization: Bearer <access>
```
**Ответ:**
```json
[
  {
    "id": 1,
    "name": "iPhone 14",
    "price": "79990.00",
    "stock": 10,
    "image_url": "https://example.com/iphone14.jpg",
    "diaganal": "6.1",
    "category": { ... }
  },
  ...
]
```

### Добавить в корзину
```http
POST /api_v3/cart/add/
Authorization: Bearer <access>
{
  "product_id": 1,
  "quantity": 2
}
```
**Ответ:**
```json
{ "detail": "Added to cart" }
```

### Применить промокод
```http
POST /api_v3/cart/apply-promocode/
Authorization: Bearer <access>
{
  "code": "PROMO10"
}
```
**Ответ:**
```json
{ "detail": "Промокод применён", "discount": 10, "total": 100000, "discounted_total": 90000 }
```

### Оформить заказ
```http
POST /api_v3/pay/
Authorization: Bearer <access>
```
**Ответ:**
```json
{ "detail": "Оплата прошла успешно", "order_id": 1 }
```

### Получить историю заказов
```http
GET /api_v3/orders/history/
Authorization: Bearer <access>
```
**Ответ:**
```json
[
  { "id": 1, "user": 2, "created_at": "2024-06-01T12:00:00Z", "total": "90000.00", "promo_code": null }
]
```

---

## Пример полного цикла работы
1. Зарегистрировать пользователя: `POST /api_v3/auth/users/`
2. Получить JWT: `POST /api_v3/auth/jwt/create/`
3. Получить список товаров: `GET /api_v3/products/` (требуется токен)
4. Добавить товар в корзину: `POST /api_v3/cart/add/`
5. Применить промокод: `POST /api_v3/cart/apply-promocode/`
6. Оформить заказ: `POST /api_v3/pay/`
7. Получить историю заказов: `GET /api_v3/orders/history/`

---

## Документация (Swagger/Redoc)
- **v1:** [Swagger](/api_v1/swagger/) | [Redoc](/api_v1/redoc/)
- **v2:** [Swagger](/api_v2/swagger/) | [Redoc](/api_v2/redoc/)
- **v3:** [Swagger](/api_v3/swagger/) | [Redoc](/api_v3/redoc/)

---

## Контакты
Автор: Fomichev Evgeniy 